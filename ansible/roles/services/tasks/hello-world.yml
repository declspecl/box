---
- name: Ensure hello-world directory exists
  file:
    path: "{{ services_dir }}/hello-world"
    state: directory
    owner: "{{ box_user }}"
    group: "{{ box_user }}"
    mode: "0755"
  become: yes

- name: Copy hello-world service
  synchronize:
    src: "{{ role_path }}/../../../services/hello-world/"
    dest: "{{ services_dir }}/hello-world/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.env"
      - "--exclude=deno.lock"
      - "--chown={{ box_user }}:{{ box_user }}"
  notify: restart hello-world

- name: Trust mise config for hello-world
  command: "{{ mise_install_dir }}/mise trust {{ services_dir }}/hello-world/mise.toml"
  become_user: "{{ box_user }}"
  changed_when: false

- name: Install hello-world dependencies via mise
  command: "{{ mise_install_dir }}/mise install"
  args:
    chdir: "{{ services_dir }}/hello-world"
  become_user: "{{ box_user }}"
  changed_when: false

- name: Create hello-world systemd service
  copy:
    dest: /etc/systemd/system/hello-world.service
    content: |
      [Unit]
      Description=Hello World Deno Service
      After=network.target

      [Service]
      Type=simple
      User={{ box_user }}
      WorkingDirectory={{ services_dir }}/hello-world
      ExecStart={{ mise_install_dir }}/mise exec -- deno task serve
      Restart=on-failure
      RestartSec=5
      Environment="PORT=7777"
      StandardOutput=append:/var/log/box/hello-world.log
      StandardError=append:/var/log/box/hello-world.log

      [Install]
      WantedBy=multi-user.target
    mode: "0644"
  notify: restart hello-world

- name: Enable and start hello-world service
  systemd:
    name: hello-world
    enabled: yes
    state: started
    daemon_reload: yes
